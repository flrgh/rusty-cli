name: test

on:
  push:
    branches:
      - main

  pull_request:
    branches:
      - '*'

defaults:
  run:
    shell: bash

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: cache
        uses: actions/cache@v3
        id: build-cache
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: install rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true
          components: cargo

      - name: cargo build
        uses: actions-rs/cargo@v1
        with:
          command: build

  test:
    needs: [ build ]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: cargo test
        uses: actions-rs/cargo@v1
        with:
          command: test

  compat:
    name: resty-cli compat
    needs: [ build ]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        openresty:
          - 1.21.4.1
        resty-cli:
          - v0.29
#        openssl:
#          - 1.1.1n
    steps:
      - uses: actions/checkout@v3

      - name: cache
        uses: actions/cache@v3
        id: build-cache
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: cargo build
        uses: actions-rs/cargo@v1
        with:
          command: build

      - name: set OpenResty prefix
        # https://github.com/thibaultcha/setup-openresty/blob/9de73a9ece161b12148d30ccd795bf9b09aba011/src/index.js#L23
        run: |
          echo OPENRESTY_PREFIX=${{ env.GITHUB_WORKSPACE }}/openresty/${{ matrix.openresty }} >> $GITHUB_ENV

      - name: cache OpenResty
        uses: actions/cache@v3
        id: cache-openresty
        with:
          path: |
            ${{ env.OPENRESTY_PREFIX }}
          key: ${{ runner.os }}-openresty-${{ matrix.openresty }}

      - name: setup OpenResty
        if: ${{ steps.cache-openresty.cache-hit != 'true' }}
        id: setup-openresty
        uses: thibaultcha/setup-openresty@main
        with:
          version: ${{ matrix.openresty }}
          test-nginx: true
#         openssl-version: ${{ matrix.openssl }}
          opt: >
            --with-compat
            --with-pcre-jit
            --with-stream
            --with-threads
#         --with-http_ssl_module

      - name: add OpenResty bin dirs to PATH
        run: |
          echo ${{ env.OPENRESTY_PREFIX }}/bin >> $GITHUB_PATH
          echo ${{ env.OPENRESTY_PREFIX }}/luajit/bin >> $GITHUB_PATH
          echo ${{ env.OPENRESTY_PREFIX }}/nginx/sbin >> $GITHUB_PATH

      - name: checkout resty-cli repo
        uses: actions/checkout@v3
        with:
          repository: openresty/resty-cli
          ref: ${{ matrix.resty-cli }}
          path: resty-cli

      - name: copy & patch files
        run: ./tests/setup-resty-cli.sh

      - name: prove
        run: prove -r ./t
