name: test

on:
  workflow_call: {}

defaults:
  run:
    shell: bash

jobs:
  cargo-test:
    name: cargo test (${{ matrix.label }})
    runs-on: ubuntu-latest

    strategy:
      matrix:
        include:
          - label: default

          - label: w/ NGINX_PATH
            NGINX_PATH: /my/nginx

    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - uses: ./.github/actions/build

      - name: cargo test
        env:
          NGINX_PATH: ${{ matrix.NGINX_PATH }}
        run: |
          if [[ -n ${NGINX_PATH:-} ]]; then
            export NGINX_PATH
          else
            unset NGINX_PATH
          fi

          # using --bins to filter out integration tests
          cargo test --bins
