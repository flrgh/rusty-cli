name: test

on:
  workflow_call: {}

defaults:
  run:
    shell: bash

jobs:
  cargo-test:
    name: cargo test (${{ matrix.label }})
    runs-on: ubuntu-latest

    strategy:
      matrix:
        include:
          - label: default

          - label: w/ NGINX_PATH
            NGINX_PATH: /my/nginx

          - label: w/ RESTY_CLI_COMPAT_VERSION
            RESTY_CLI_COMPAT_VERSION: v0.30

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      - uses: ./.github/actions/build

      - name: cargo test
        env:
          NGINX_PATH: ${{ matrix.NGINX_PATH }}
          RESTY_CLI_COMPAT_VERSION: ${{ matrix.RESTY_CLI_COMPAT_VERSION }}
        run: |
          if [[ -n ${NGINX_PATH:-} ]]; then
            export NGINX_PATH
          else
            unset NGINX_PATH
          fi

          if [[ -n ${RESTY_CLI_COMPAT_VERSION:-} ]]; then
            export RESTY_CLI_COMPAT_VERSION
          else
            unset RESTY_CLI_COMPAT_VERSION
          fi

          # using --bins to filter out integration tests
          cargo test --bins
